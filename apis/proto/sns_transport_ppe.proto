// @file sns_transport_ppe.proto
//
// @brief Defines API for the Transport Post Processing Engine (PPE)
//
// @copyright 
// Copyright (c) 2023-2024 Qualcomm Innovation Center, Inc. All rights reserved.
// SPDX-License-Identifier: BSD-3-Clause-Clear
//
// @details The Transport PPE performs post processing tasks such as filtering of
// events from Transport drivers such as BLE.
//
// ## Attribute Requirements:
// 1. SNS_STD_SENSOR_ATTRID_TYPE: "transport_ppe"
// 2. SNS_STD_SENSOR_ATTRID_STREAM_TYPE: SNS_STD_SENSOR_STREAM_TYPE_ON_CHANGE
// 3. SNS_STD_SENSOR_ATTRID_API attribute contains "sns_transport_ppe.proto"
//
// ## Processing Stream Requests:
// - SNS_TRANSPORT_PPE_MSGID_SNS_TRANSPORT_PPE_CONFIG is used to enable TPPE.
//
// ## Publishing Stream Events:
// - SNS_TRANSPORT_PPE_MSGID_SNS_TRANSPORT_PPE_EVENT is the event generated by TPPE.

syntax = "proto2";
import "nanopb.proto";
import "sns_std.proto";


// @details Message Ids for the Transport PPE Sensor.
// These are the only messages Transport PPE Sensor processes.
// Messages with all other Ids are passed through.
enum sns_transport_ppe_msgid
{
  option (nanopb_enumopt).long_names = false;

  SNS_TRANSPORT_PPE_MSGID_SNS_TRANSPORT_PPE_CONFIG = 4;

  SNS_TRANSPORT_PPE_MSGID_SNS_TRANSPORT_PPE_EVENT = 257;
}

// @brief The TPPE Property Count
enum sns_transport_ppe_prop
{
  option (nanopb_enumopt).long_names = false;

  SNS_TRANSPORT_PPE_PROP_COUNT = 12;
}

// @brief The TPPE ID
message sns_transport_ppe_id
{
  required fixed64 id_low = 1;
  required fixed64 id_high = 2;
}

// @brief The TPPE Data Filter
message sns_transport_ppe_data_filter
{
  required sns_transport_ppe_id id = 1;

  // @details The mask specifies the location of the bits that need to be compared using
  // the provided value. For any bit in the mask, set it to 1 if it needs to be
  // compared, otherwise set it to 0 to ignore.
  // Mask and Value must be of the same length.
  required bytes mask = 2;

  required bytes value = 3;
}

// @details ## Property Filters: Used to set a filter on properties
// associated with the Transport Event.
//
// ## Equal Threshold:
// The Transport Event property must be an exact byte match to the
// one specified by the value in the property filter for the trigger criteria
// to be met.
//
// ## Max Threshold:
// The Transport Event property must be <= the value in the property filter
// for the trigger criteria to be met.
//
// ## Min Threshold:
// The Transport Event property must be >= the value in the property filter
// for the trigger criteria to be met.
enum sns_transport_ppe_threshold {
  option (nanopb_enumopt).long_names = false;

  SNS_TRANSPORT_PPE_THRESHOLD_UNINITIALIZED = 0;
  SNS_TRANSPORT_PPE_THRESHOLD_MIN = 1;
  SNS_TRANSPORT_PPE_THRESHOLD_MAX = 2;
  SNS_TRANSPORT_PPE_THRESHOLD_EQUAL = 3;
}

// @brief TPPE Properties
message sns_transport_property {
  oneof prop {
    // @brief Event Type
    bytes event_type = 1 [(nanopb).max_size = 1, (nanopb).fixed_length = true];

    // @brief Device Address Type
    bytes device_addr_type = 2 [(nanopb).max_size = 1, (nanopb).fixed_length = true];

    // @brief Device Address
    bytes device_addr = 3 [(nanopb).max_size = 6, (nanopb).fixed_length = true];

    // @brief Timestamp in units of QTimer ticks
    fixed64 timestamp = 4;

    // @brief Tx Power in dBm
    sint32 tx_power = 5;

    // @brief RSSI in dBm
    sint32 rssi = 6;

    // @brief Primary PHY
    bytes primary_phy = 7 [(nanopb).max_size = 1, (nanopb).fixed_length = true];

    // @brief Secondary PHY
    bytes secondary_phy = 8 [(nanopb).max_size = 1, (nanopb).fixed_length = true];

    // @brief Advertising SID
    bytes adv_sid = 9 [(nanopb).max_size = 1, (nanopb).fixed_length = true];

    // @brief Periodic Advertising Interval
    uint32 periodic_adv_interval = 10;

    // @brief Direct Address Type
    bytes direct_addr_type = 11 [(nanopb).max_size = 1, (nanopb).fixed_length = true];

    // @brief Direct Address
    bytes direct_addr = 12 [(nanopb).max_size = 6, (nanopb).fixed_length = true];
  }
}

// @brief TPPE Prop Filter 
message sns_transport_ppe_prop_filter {
  required sns_transport_property prop = 1;

  // @brief Conveys if value is a minimum, maximum or equal threshold.
  required sns_transport_ppe_threshold threshold = 2 [default = SNS_TRANSPORT_PPE_THRESHOLD_EQUAL];
}

// @brief TPPE Filter
message sns_transport_ppe_filter {
  option (nanopb_msgopt).no_unions = true;
  oneof filter {
    sns_transport_ppe_prop_filter prop_filter = 1;

    // @brief Service data filter is met if there exists atleast one service data in the
    // Transport Event that matches the fields defined in service_data_filter.
    sns_transport_ppe_data_filter service_data_filter = 2;

    // @brief Manufacturer data filter is met if there exists atleast one manufacturer
    // data in the Transport Event with the fields defined in
    // manuf_data_filter
    sns_transport_ppe_data_filter manuf_data_filter = 3;
  }
}

// @brief Duplicate Detection Config
message sns_transport_ppe_dup_detection {
  // @brief Duplicate detection filters
  // If specified, the events that satisfy ALL filters are considered for 
  // duplicate detection.
  // If duplicate detection is requested without filters, all events will be 
  // considered for duplicate detection.
  repeated sns_transport_ppe_filter dup_detect_filters = 1;

  // @brief Duplicate detection period
  // If specified, first occurrence of the event in each period is delivered and
  // duplicates within same period are dropped.
  // Period starts from the time a request is received and repeats every 
  // 'dup_detect_period' seconds.
  optional uint32 dup_detect_period = 2;
}

// @details ## Triggers
//
// A trigger is defined by an associated trigger id, set of wakeup filters
// and/or duplicate detection filters.
//
// Duplicate Detection
//
// If duplicate detection is enabled, first occurrence of the event is delivered
// All subsequent events with same data are considered duplicates and dropped.
//
// If duplicate detection is enabled, wakeup filters are applied before 
// duplicate detection.
//
// After wakeup filtering and duplicate detection, the relevant events will be
// delivered to the end client as part of sns_transport_ppe_event with the
// associated trigger id.
message sns_transport_ppe_trigger {

  // @brief Wakeup Filters
  // If specified, the transport events will be delivered to the client if and 
  // only if the event satisfies ALL the filters.
  repeated sns_transport_ppe_filter wakeup_filters = 1;

  // @brief identifier associated with this trigger
  required uint32 trigger_id = 2;

  // @brief Duplicate detection feature is disabled by default.
  // Specify dup_detection to enable duplicate detection feature.
  optional sns_transport_ppe_dup_detection dup_detection = 3;
}

// @details ## Transport PPE Configuration message
//
// Uses Msg ID SNS_TRANSPORT_PPE_MSGID_SNS_TRANSPORT_PPE_CONFIG
//
// This must be the first message sent to the Transport PPE Sensor.
// All other messages are rejected with an error event until this message
// is received.
// Subsequent to receiving the Config message, all messages outside of the
// ones defined in sns_transport_ppe_msgid are passed through.
//
// The Config message must represent all of the required settings for the
// client on that connection. Any subsequent Config message overrides previous
// config settings
//
// For every Transport Event that satisfies ATLEAST ONE of the triggers
// provided in sns_transport_ppe_config, an event of type
// sns_transport_ppe_event is sent to the client carrying the original event
// as payload and a list of all the trigger_ids that were satisfied by the
// event.
//
// If no triggers are provided in sns_transport_ppe_config, for every event
// received from underlying transport layer, an event of type
// sns_transport_ppe_event is sent to the client carrying original event as
// payload with no trigger ids
message sns_transport_ppe_config {

  // @brief Trigger settings applied to all transport events
  repeated sns_transport_ppe_trigger triggers = 1;

  // @brief Client specified custom configuration
  optional bytes custom_config = 2;
}

// @details ## Transport PPE Event message
//
// Uses Msg ID SNS_TRANSPORT_PPE_MSGID_SNS_TRANSPORT_PPE_EVENT
message sns_transport_ppe_event
{
  // @brief Msg ID of the Event
  required uint32 event_msg_id = 1;

  // @brief Transport Event Message
  optional bytes event = 2;

  // @brief List of trigger_ids specified in sns_transport_ppe_config that were
  // satisfied by this event
  repeated uint32 trigger_ids = 3;
}
